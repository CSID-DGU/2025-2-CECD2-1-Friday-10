<!DOCTYPE html>
<html>
<head>
    <title>Skeleton Upload & Retrieval (Restful API Test)</title>
    <meta charset="UTF-8" />
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea, input[type="text"], input[type="password"] { width: 100%; margin-bottom: 10px; padding: 8px; }
        button { padding: 10px 15px; margin-top: 5px; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        h3 { margin-top: 0; }
        pre { background-color: #f4f4f4; padding: 10px; overflow-x: auto; }
        #loginStatus { font-weight: bold; color: green; margin-bottom: 10px; }
    </style>
</head>
<body>

<h2>ğŸ¦´ Skeleton Upload & Retrieval Panel (RESTful API)</h2>

<div id="loginStatus">ë¡œê·¸ì¸ ìƒíƒœ: âŒ</div>

<div class="section">
    <h3>ğŸ”‘ íšŒì›ê°€ì… / ë¡œê·¸ì¸</h3>
    <input type="text" id="signupUserId" placeholder="User ID (íšŒì›ê°€ì…)">
    <input type="password" id="signupPassword" placeholder="Password (íšŒì›ê°€ì…)">
    <button onclick="signup()">íšŒì›ê°€ì…</button>
    <div id="signupResult" style="color: green;"></div>
    
    <hr style="margin: 10px 0;">

    <input type="text" id="loginUserId" placeholder="User ID (ë¡œê·¸ì¸)">
    <input type="password" id="loginPassword" placeholder="Password (ë¡œê·¸ì¸)">
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="loginResult" style="color: blue;"></div>
</div>

<div class="section">
    <h3>ğŸ—‘ï¸ íšŒì› íƒˆí‡´ (ë¡œê·¸ì¸ í•„ìš”)</h3>
    <p>â—ï¸ í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •ì„ íƒˆí‡´í•©ë‹ˆë‹¤. User ID ì…ë ¥ í•„ë“œëŠ” ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
    <button onclick="deleteUser()">íšŒì› íƒˆí‡´</button>
    <div id="deleteResult" style="color: red;"></div>
</div>

<hr>

<div class="section">
    <h3>1ï¸âƒ£ Skeleton ë°ì´í„° ì—…ë¡œë“œ (POST /api/upload/skeleton)</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨. ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    
    <label>ğŸ“¹ Video Name:</label>
    <input type="text" id="uploadVideoName" placeholder="ex: íƒœê·¹1ì¥" />

    <label>ğŸ“¹ Extension:</label>
    <input type="text" id="fileExtension" placeholder="ex: mp4" />
    
    <label>ğŸ¦´ Joints JSON:</label>
    <textarea id="uploadSkeletonJson" placeholder="ì—¬ê¸°ì— joints JSONì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    
    <button onclick="uploadSkeleton()">ğŸ“¤ Upload Skeleton</button>
    <div id="uploadResult" style="color: green; white-space: pre-line;"></div>
</div>

<div class="section">
    <h3>2ï¸âƒ£ Video / Photo ì—…ë¡œë“œ (Presigned URL)</h3>
    <p>URL ìƒì„± í›„, ì´ íŒŒì¼ì´ S3ë¡œ ì§ì ‘ PUT ìš”ì²­ë©ë‹ˆë‹¤.</p>
    <input type="file" id="photoFile" accept="video/*">
    <button onclick="uploadPhoto()">ğŸ“¤ Upload File</button>
    <div id="photoUploadResult" style="color: blue; white-space: pre-line;"></div>
</div>

<hr>

<div class="section">
    <h3>3ï¸âƒ£ Skeleton JSON ì¡°íšŒ (GET /api/skeleton/videos/{videoId})</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨. ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ë¹„ë””ì˜¤ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    
    <label>ğŸ“¹ Video ID:</label>
    <input type="text" id="getVideoId" placeholder="ex: 1234 (Long íƒ€ì… ID)" />
    
    <button onclick="getSkeleton()">ğŸ” Get Skeleton JSON</button>
    <textarea id="skeletonOutput" readonly placeholder="ì¡°íšŒëœ joints JSON ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    <div id="retrieveResult" style="color: red;"></div>
</div>

<div class="section">
    <h3>4ï¸âƒ£ ì‚¬ìš©ì ì „ì²´ Video ëª©ë¡ ì¡°íšŒ (GET /api/videos)</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨. ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ëª©ë¡ë§Œ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
    
    <button onclick="getUserVideos()">ğŸ“‹ Get Video List</button>
    <pre id="videoListOutput"></pre>
</div>

<div class="section">
    <h3>5ï¸âƒ£ Skeleton ì‚­ì œ (DELETE /api/videos/{videoId})</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨.</p>
    
    <label>ğŸ“¹ Video ID:</label>
    <input type="text" id="deleteVideoId" placeholder="ex: 1234" />
    
    <button onclick="deleteSkeleton()">ğŸ—‘ï¸ Delete Skeleton</button>
    <div id="deleteSkeletonResult" style="color: red;"></div>
</div>

<div class="section">
    <h3>6ï¸âƒ£ Video ë‹¤ìš´ë¡œë“œ (GET /api/download/videos/{videoId})</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨.</p>

    <label>ğŸ“¹ Video ID:</label>
    <input type="text" id="downloadVideoId" placeholder="ex: 1234" />

    <button onclick="downloadFile()">â¬‡ï¸ Download File</button>
    <div id="downloadResult" style="color: purple; white-space: pre-line;"></div>
</div>

<hr>

<div class="section">
    <h3>7ï¸âƒ£ ì ìˆ˜ ì €ì¥ (POST /api/score/videos/{videoId}/score)</h3>
    <p>â—ï¸ ì ìˆ˜ëŠ” ìš”ì²­ ë³¸ë¬¸(Body)ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</p>
    <label>ğŸ“¹ Video ID:</label>
    <input type="text" id="saveVideoId" placeholder="ex: 1234" />
    <label>â­ Score:</label>
    <input type="text" id="saveScoreValue" placeholder="ex: 85.4 (String ë˜ëŠ” Number)" />
    <button onclick="saveScore()">ğŸ’¾ Save Score</button>
    <div id="saveScoreResult" style="color: green; white-space: pre-line;"></div>
</div>

<div class="section">
    <h3>8ï¸âƒ£ ì ìˆ˜ ì¡°íšŒ (GET /api/score/videos/{videoId})</h3>
    <p>â—ï¸ User ID ì…ë ¥ í•„ë“œ ì œê±°ë¨.</p>
    <label>ğŸ“¹ Video ID:</label>
    <input type="text" id="getScoreVideoId" placeholder="ex: 1234" />
    <button onclick="getScore()">ğŸ” Get Score</button>
    <div id="getScoreResult" style="color: blue; white-space: pre-line;"></div>
</div>

<script>
let jwtToken = "";
let presignedUploadUrl = "";
let presignedObjectName = "";

function updateLoginStatus() {
    const statusElem = document.getElementById("loginStatus");
    statusElem.innerText = jwtToken ? "ë¡œê·¸ì¸ ìƒíƒœ: âœ…" : "ë¡œê·¸ì¸ ìƒíƒœ: âŒ";

    if (!jwtToken) {
        presignedUploadUrl = "";
        presignedObjectName = "";
        document.getElementById("uploadResult").innerText = "ë¡œê·¸ì•„ì›ƒìœ¼ë¡œ ì—…ë¡œë“œ URL ì´ˆê¸°í™”ë¨.";
    }
}

// ---------------- íšŒì›ê°€ì…/ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ----------------

function signup() {
    const userId = document.getElementById("signupUserId").value.trim();
    const password = document.getElementById("signupPassword").value.trim();
    if (!userId || !password) { alert("User IDì™€ Passwordë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    fetch("/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, password })
    })
    .then(res => {
        if (!res.ok) throw new Error("íšŒì›ê°€ì… ì‹¤íŒ¨");
        return res.json();
    })
    .then(() => {
        document.getElementById("signupResult").innerText = "âœ… íšŒì›ê°€ì… ì„±ê³µ!";
    })
    .catch(err => {
        document.getElementById("signupResult").innerText = `âŒ íšŒì›ê°€ì… ì‹¤íŒ¨: ${err.message}`;
    });
}

function login() {
    const userId = document.getElementById("loginUserId").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    if (!userId || !password) { alert("User IDì™€ Passwordë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, password })
    })
    .then(res => {
        if (!res.ok) throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");
        return res.json();
    })
    .then(data => {
        jwtToken = data.token;
        document.getElementById("loginResult").innerText = "âœ… ë¡œê·¸ì¸ ì„±ê³µ!";
        updateLoginStatus();
    })
    .catch(err => {
        document.getElementById("loginResult").innerText = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${err.message}`;
        jwtToken = "";
        updateLoginStatus();
    });
}

function logout() {
    jwtToken = "";
    updateLoginStatus();
    document.getElementById("loginResult").innerText = "ğŸ”’ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ";
}

// ---------------- íšŒì› íƒˆí‡´ (DELETE /auth/users) ----------------
function deleteUser() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    fetch(`/auth/users`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => {
        if (res.status === 204) {
            document.getElementById("deleteResult").innerText = "âœ… íšŒì› íƒˆí‡´ ì™„ë£Œ (ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ë¨)";
            logout();
        }
        else if (res.status === 404) document.getElementById("deleteResult").innerText = "âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
        else throw new Error(`íƒˆí‡´ ì‹¤íŒ¨ (Status: ${res.status})`);
    })
    .catch(err => {
        document.getElementById("deleteResult").innerText = `âŒ íšŒì› íƒˆí‡´ ì‹¤íŒ¨: ${err.message}`;
    });
}

// ---------------- 1ï¸âƒ£ Skeleton ë°ì´í„° ì—…ë¡œë“œ (POST /api/upload/skeleton) ----------------
function uploadSkeleton() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    const videoName = document.getElementById("uploadVideoName").value.trim();
    const fileExtension = document.getElementById("fileExtension").value.trim();
    const jointsJson = document.getElementById("uploadSkeletonJson").value.trim();
    if (!videoName || !fileExtension || !jointsJson) { alert("ëª¨ë“  ì…ë ¥ê°’ì„ ì±„ì›Œì£¼ì„¸ìš”."); return; }

    let jointsObj;
    try { jointsObj = JSON.parse(jointsJson); } 
    catch { alert("Joints JSONì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

    fetch("/api/upload/skeleton", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + jwtToken },

        body: JSON.stringify({ videoName, fileExtension, joints: jointsObj })
    })
    .then(res => {
        if (!res.ok) throw new Error(`ì—…ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨ (Status: ${res.status})`);
        return res.json();
    })
    .then(data => {
        presignedUploadUrl = data.uploadUrl;
        presignedObjectName = data.objectName;
        document.getElementById("uploadResult").innerText =
            `âœ… ì—…ë¡œë“œ URL ìƒì„± ì„±ê³µ!\nBucket: ${data.bucket}\nObject: ${data.objectName}\nUpload URL: ${data.uploadUrl}`;
    })
    .catch(err => { document.getElementById("uploadResult").innerText = `âŒ Skeleton ì—…ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 2ï¸âƒ£ Video / Photo ì—…ë¡œë“œ ----------------
function uploadPhoto() {
    const fileInput = document.getElementById("photoFile");
    if (!fileInput.files.length) { alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    if (!presignedUploadUrl) { alert("ë¨¼ì € Skeleton JSON ì—…ë¡œë“œ í›„ Presigned URLì„ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤."); return; }

    const file = fileInput.files[0];

    fetch(presignedUploadUrl, { 
        method: "PUT", 
        headers: { "Content-Type": file.type || "application/octet-stream" },
        body: file 
    })
    .then(res => {
        if (res.ok) document.getElementById("photoUploadResult").innerText = "âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!";
        else document.getElementById("photoUploadResult").innerText = `âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ (status: ${res.status})`;
    })
    .catch(err => { document.getElementById("photoUploadResult").innerText = `âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 3ï¸âƒ£ Skeleton JSON ì¡°íšŒ (GET /api/skeleton/videos/{videoId}) ----------------
function getSkeleton() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    const videoId = document.getElementById("getVideoId").value.trim();
    if (!videoId) { alert("Video IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    fetch(`/api/skeleton/videos/${videoId}`, {
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => { 
        if (res.status === 404) throw new Error("ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        if (!res.ok) throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (Status: ${res.status})`); 
        return res.json(); 
    })
    .then(data => { 

        document.getElementById("skeletonOutput").value = JSON.stringify(data.joints, null, 2) || ""; 
    })
    .catch(err => { 
        document.getElementById("skeletonOutput").value = "";
        document.getElementById("retrieveResult").innerText = `âŒ ì¡°íšŒ ì‹¤íŒ¨: ${err.message}`;
    });
}

// ---------------- 4ï¸âƒ£ ì‚¬ìš©ì ì „ì²´ Video ëª©ë¡ ì¡°íšŒ (GET /api/videos) ----------------
function getUserVideos() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }



    fetch(`/api/videos`, {
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => {
        if (!res.ok) throw new Error(`ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (Status: ${res.status})`);
        return res.json();
    })
    .then(data => {
        if (Array.isArray(data) && data.length > 0) {
            const output = data.map(video => `ğŸ“¹ videoId: ${video.videoId}, ğŸ“ videoName: ${video.videoName}, ğŸ•’ uploadTime: ${video.uploadTime}`).join("\n");
            document.getElementById("videoListOutput").innerText = output;
        } else { document.getElementById("videoListOutput").innerText = "â—ï¸í•´ë‹¹ ìœ ì €ì˜ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤."; }
    })
    .catch(err => { document.getElementById("videoListOutput").innerText = `âŒ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 5ï¸âƒ£ Skeleton ì‚­ì œ (DELETE /api/videos/{videoId}) ----------------
function deleteSkeleton() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    const videoId = document.getElementById("deleteVideoId").value.trim();
    if (!videoId) { alert("Video IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }


    fetch(`/api/videos/${videoId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => {
        if (res.status === 204) document.getElementById("deleteSkeletonResult").innerText = "âœ… ì‚­ì œ ì™„ë£Œ";
        else if (res.status === 404) document.getElementById("deleteSkeletonResult").innerText = "âŒ ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì†Œìœ ìê°€ ì•„ë‹™ë‹ˆë‹¤.";
        else throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (Status: ${res.status})`);
    })
    .catch(err => { document.getElementById("deleteSkeletonResult").innerText = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 6ï¸âƒ£ Video ë‹¤ìš´ë¡œë“œ (GET /api/download/videos/{videoId}) ----------------
function downloadFile() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    const videoId = document.getElementById("downloadVideoId").value.trim();
    if (!videoId) { alert("Video IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    fetch(`/api/download/videos/${videoId}`, {
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => {
        if (!res.ok) throw new Error(`ë‹¤ìš´ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨ (Status: ${res.status})`);
        return res.json();
    })
    .then(data => {
        if (data.downloadUrl) {
            document.getElementById("downloadResult").innerText = `âœ… ë‹¤ìš´ë¡œë“œ URL ìƒì„± ì™„ë£Œ. ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nURL: ${data.downloadUrl}`;

            const a = document.createElement("a");
            a.href = data.downloadUrl;
            a.download = data.videoName || `video_${videoId}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } else {
            throw new Error("ë‹¤ìš´ë¡œë“œ URLì´ ì‘ë‹µì— ì—†ìŠµë‹ˆë‹¤.");
        }
    })
    .catch(err => { document.getElementById("downloadResult").innerText = `âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 7ï¸âƒ£ ì ìˆ˜ ì €ì¥ (POST /api/score/videos/{videoId}/score) ----------------
function saveScore() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }
    const videoId = document.getElementById("saveVideoId").value.trim();
    const score = document.getElementById("saveScoreValue").value.trim();
    if (!videoId || !score) { alert("Video IDì™€ Scoreë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }


    fetch(`/api/score/videos/${videoId}/score`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": "Bearer " + jwtToken 
        },
        body: JSON.stringify({ score })
    })
    .then(res => {
        if (!res.ok) throw new Error(`ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨ (Status: ${res.status})`);
        return res.text();
    })
    .then(data => { document.getElementById("saveScoreResult").innerText = `âœ… ${data}`; })
    .catch(err => { document.getElementById("saveScoreResult").innerText = `âŒ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨: ${err.message}`; });
}

// ---------------- 8ï¸âƒ£ ì ìˆ˜ ì¡°íšŒ (GET /api/score/videos/{videoId}) ----------------
function getScore() {
    if (!jwtToken) { alert("ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); return; }

    const videoId = document.getElementById("getScoreVideoId").value.trim();
    if (!videoId) { alert("Video IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    fetch(`/api/score/videos/${videoId}`, {
        headers: { "Authorization": "Bearer " + jwtToken }
    })
    .then(res => {
        if (res.status === 404) throw new Error("ì ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!res.ok) throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (Status: ${res.status})`);
        return res.text();
    })
    .then(data => { document.getElementById("getScoreResult").innerText = `ğŸ¯ ì ìˆ˜: ${data}`; })
    .catch(err => { document.getElementById("getScoreResult").innerText = `âŒ ì ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨: ${err.message}`; });
}

updateLoginStatus();
</script>

</body>
</html>